package handlers

import (
	"context"
	"fmt"
	"log"
	"strconv"
	"strings"
	"sync"
	"time"

	"vpn-telegram-bot/internal/middleware"
	"vpn-telegram-bot/internal/models"

	tele "gopkg.in/telebot.v3"
)

// adminState —Ö—Ä–∞–Ω–∏—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
type adminState struct {
	mu       sync.Mutex
	sessions map[int64]*adminSession
}

type adminSession struct {
	state     string // "search_user", "topup_amount", "gift_product", "gift_days", "message_text"
	userID    int64  // –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
	productID int64
	days      int
	amount    float64
}

var adminFSM = &adminState{
	sessions: make(map[int64]*adminSession),
}

// broadcastState —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
type broadcastState struct {
	mu             sync.Mutex
	isActive       bool
	waitingMsg     bool
	waitingConfirm bool
	adminID        int64
	message        *tele.Message
}

var broadcast = &broadcastState{}

// RegisterAdmin —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∞–¥–º–∏–Ω-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
func (h *Handler) RegisterAdmin(b *tele.Bot) {
	adminGroup := b.Group()
	adminGroup.Use(middleware.AdminMiddleware(h.adminIDs))

	// –ö–æ–º–∞–Ω–¥—ã
	adminGroup.Handle("/ahelp", h.HandleAdmin)
	adminGroup.Handle("/admin", h.HandleAdmin) // Legacy support

	// Callbacks –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
	adminGroup.Handle(&tele.Btn{Unique: "admin_users"}, h.HandleAdminUsers)
	adminGroup.Handle(&tele.Btn{Unique: "admin_stats"}, h.HandleAdminStats)
	adminGroup.Handle(&tele.Btn{Unique: "admin_broadcast"}, h.HandleAdminBroadcast)
	adminGroup.Handle(&tele.Btn{Unique: "admin_issue"}, h.HandleAdminIssue)
	adminGroup.Handle(&tele.Btn{Unique: "admin_back"}, h.HandleAdmin)

	// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
	adminGroup.Handle(&tele.Btn{Unique: "admin_user_search"}, h.HandleUserSearchStart)
	adminGroup.Handle(&tele.Btn{Unique: "admin_user_topup"}, h.HandleUserTopupStart)
	adminGroup.Handle(&tele.Btn{Unique: "admin_user_gift"}, h.HandleUserGiftStart)
	adminGroup.Handle(&tele.Btn{Unique: "admin_user_message"}, h.HandleUserMessageStart)
	adminGroup.Handle(&tele.Btn{Unique: "admin_user_back"}, h.HandleAdminUsers)
	adminGroup.Handle(&tele.Btn{Unique: "gift_product"}, h.HandleUserGiftProduct)
	adminGroup.Handle(&tele.Btn{Unique: "gift_days_btn"}, h.HandleUserGiftDaysBtn)

	// –í—ã–¥–∞—á–∞ –∫–ª—é—á–∞
	adminGroup.Handle(&tele.Btn{Unique: "issue_product"}, h.HandleIssueProduct)
	adminGroup.Handle(&tele.Btn{Unique: "issue_days"}, h.HandleIssueDays)
	adminGroup.Handle(&tele.Btn{Unique: "issue_no_user"}, h.HandleIssueNoUser)
	adminGroup.Handle(&tele.Btn{Unique: "issue_cancel"}, h.HandleIssueCancel)

	// –†–∞—Å—Å—ã–ª–∫–∞
	adminGroup.Handle(&tele.Btn{Unique: "admin_cancel_broadcast"}, h.HandleCancelBroadcast)
	adminGroup.Handle(&tele.Btn{Unique: "admin_confirm_broadcast"}, h.HandleConfirmBroadcast)

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (FSM)
	b.Handle(tele.OnText, func(c tele.Context) error {
		if !h.isAdmin(c.Sender().ID) {
			return nil
		}

		adminFSM.mu.Lock()
		session, exists := adminFSM.sessions[c.Sender().ID]
		adminFSM.mu.Unlock()

		if !exists {
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º broadcast
			broadcast.mu.Lock()
			waiting := broadcast.waitingMsg && broadcast.adminID == c.Sender().ID
			broadcast.mu.Unlock()

			if waiting {
				return h.HandleBroadcastMessage(c)
			}
			return nil
		}

		switch session.state {
		case "search_user":
			return h.HandleUserSearchQuery(c)
		case "topup_amount":
			return h.HandleUserTopupAmount(c)
		case "gift_product":
			return h.HandleUserGiftProduct(c)
		case "gift_days":
			return h.HandleUserGiftDays(c)
		case "message_text":
			return h.HandleUserMessageText(c)
		}

		return nil
	})

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
	b.Handle(tele.OnPhoto, func(c tele.Context) error {
		if !h.isAdmin(c.Sender().ID) {
			return nil
		}
		broadcast.mu.Lock()
		waiting := broadcast.waitingMsg && broadcast.adminID == c.Sender().ID
		broadcast.mu.Unlock()
		if waiting {
			return h.HandleBroadcastMessage(c)
		}
		return nil
	})

	b.Handle(tele.OnVideo, func(c tele.Context) error {
		if !h.isAdmin(c.Sender().ID) {
			return nil
		}
		broadcast.mu.Lock()
		waiting := broadcast.waitingMsg && broadcast.adminID == c.Sender().ID
		broadcast.mu.Unlock()
		if waiting {
			return h.HandleBroadcastMessage(c)
		}
		return nil
	})
}

// isAdmin –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
func (h *Handler) isAdmin(userID int64) bool {
	for _, adminID := range h.adminIDs {
		if userID == adminID {
			return true
		}
	}
	return false
}

// setAdminState —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
func (h *Handler) setAdminState(userID int64, state string) {
	adminFSM.mu.Lock()
	defer adminFSM.mu.Unlock()
	adminFSM.sessions[userID] = &adminSession{state: state}
}

// clearAdminState –æ—á–∏—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM
func (h *Handler) clearAdminState(userID int64) {
	adminFSM.mu.Lock()
	defer adminFSM.mu.Unlock()
	delete(adminFSM.sessions, userID)
}

// getAdminSession –ø–æ–ª—É—á–∞–µ—Ç —Å–µ—Å—Å–∏—é
func (h *Handler) getAdminSession(userID int64) (*adminSession, bool) {
	adminFSM.mu.Lock()
	defer adminFSM.mu.Unlock()
	session, ok := adminFSM.sessions[userID]
	return session, ok
}

// respondAdmin –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ callback –¥–ª—è –∞–¥–º–∏–Ω–∞
func respondAdmin(c tele.Context) {
	if c.Callback() != nil {
		c.Respond()
	}
}

// editOrEditCaptionAdmin –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç EditCaption (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ) –∏–ª–∏ Edit –¥–ª—è –∞–¥–º–∏–Ω–∞
func editOrEditCaptionAdmin(c tele.Context, text string, menu *tele.ReplyMarkup) error {
	if c.Message() != nil && c.Message().Photo != nil {
		return c.EditCaption(text, menu)
	}
	return c.Edit(text, menu)
}

// ================= ADMIN PANEL =================

// HandleAdmin –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (Control Center)
func (h *Handler) HandleAdmin(c tele.Context) error {
	respondAdmin(c)
	h.clearAdminState(c.Sender().ID)

	text := "üõ† Control Panel\n\n–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("üìä Stats", "admin_stats"),
			menu.Data("üë• Users", "admin_users"),
		),
		menu.Row(
			menu.Data("üîë Quick Key", "admin_issue"),
			menu.Data("üì¢ Broadcast", "admin_broadcast"),
		),
	)

	if c.Callback() != nil {
		return c.Edit(text, menu)
	}
	return c.Send(text, menu)
}

// HandleAdminStats –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
func (h *Handler) HandleAdminStats(c tele.Context) error {
	respondAdmin(c)

	stats, err := h.svc.GetAdminStats(context.Background())
	if err != nil {
		log.Printf("Error getting admin stats: %v", err)
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"})
	}

	text := fmt.Sprintf(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: %d
üîë –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫: %d

üí∞ –î–æ—Ö–æ–¥:
‚Ä¢ –°–µ–≥–æ–¥–Ω—è: %.2f ‚ÇΩ
‚Ä¢ –ó–∞ –º–µ—Å—è—Ü: %.2f ‚ÇΩ
‚Ä¢ –í—Å–µ–≥–æ: %.2f ‚ÇΩ`,
		stats.TotalUsers,
		stats.ActiveSubscriptions,
		stats.RevenueToday,
		stats.RevenueMonth,
		stats.RevenueAllTime,
	)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", "admin_stats")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_back")),
	)

	return c.Edit(text, menu)
}

// ================= USERS SECTION =================

// HandleAdminUsers –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
func (h *Handler) HandleAdminUsers(c tele.Context) error {
	respondAdmin(c)
	h.clearAdminState(c.Sender().ID)

	text := "üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üîç –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", "admin_user_search")),
		menu.Row(menu.Data("üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", "admin_user_topup")),
		menu.Row(menu.Data("üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "admin_user_gift")),
		menu.Row(menu.Data("‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", "admin_user_message")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_back")),
	)

	return c.Edit(text, menu)
}

// HandleUserSearchStart –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (h *Handler) HandleUserSearchStart(c tele.Context) error {
	respondAdmin(c)
	h.setAdminState(c.Sender().ID, "search_user")

	text := "üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n–í–≤–µ–¥–∏—Ç–µ @username –∏–ª–∏ Telegram ID:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")),
	)

	return c.Edit(text, menu)
}

// HandleUserSearchQuery –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–∏—Å–∫–∞
func (h *Handler) HandleUserSearchQuery(c tele.Context) error {
	query := strings.TrimSpace(c.Text())
	originalQuery := query

	// –û—á–∏—â–∞–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
	query = strings.TrimPrefix(query, "@")
	query = strings.TrimSpace(query)

	if query == "" {
		text := "‚ùå –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å\n\n–í–≤–µ–¥–∏—Ç–µ @username –∏–ª–∏ Telegram ID:"
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	log.Printf("[AdminSearch] Searching for: '%s' (original: '%s')", query, originalQuery)

	// –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ ID
	var user *models.UserProfile
	var err error

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å —á–∏—Å–ª–æ–º
	if id, parseErr := strconv.ParseInt(query, 10, 64); parseErr == nil {
		// –ü–æ–∏—Å–∫ –ø–æ Telegram ID
		log.Printf("[AdminSearch] Searching by Telegram ID: %d", id)
		user, err = h.svc.FindUser(context.Background(), strconv.FormatInt(id, 10))
	} else {
		// –ü–æ–∏—Å–∫ –ø–æ username (case-insensitive)
		log.Printf("[AdminSearch] Searching by username: '%s'", query)
		user, err = h.svc.FindUser(context.Background(), query)
	}

	if err != nil || user == nil {
		h.clearAdminState(c.Sender().ID)
		text := fmt.Sprintf("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω\n\n–ó–∞–ø—Ä–æ—Å: %s\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞.", originalQuery)

		menu := &tele.ReplyMarkup{}
		menu.Inline(
			menu.Row(menu.Data("üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", "admin_user_search")),
			menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")),
		)

		// –ò—Å–ø–æ–ª—å–∑—É–µ–º Edit –µ—Å–ª–∏ —ç—Ç–æ callback, –∏–Ω–∞—á–µ Send
		if c.Message() != nil {
			msg, _ := c.Bot().Send(c.Chat(), text, menu)
			c.Bot().Delete(c.Message())
			h.saveMenuMessage(c.Sender().ID, msg.ID)
		} else {
			return editOrEditCaptionAdmin(c, text, menu)
		}
		return nil
	}

	log.Printf("[AdminSearch] ‚úÖ Found user: ID=%d, Username=@%s", user.User.TelegramID, user.User.Username)

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	adminFSM.mu.Lock()
	if session, ok := adminFSM.sessions[c.Sender().ID]; ok {
		session.userID = user.User.TelegramID
		session.state = ""
	}
	adminFSM.mu.Unlock()

	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
	return h.showUserProfile(c, user)
}

// showUserProfile –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (h *Handler) showUserProfile(c tele.Context, profile *models.UserProfile) error {
	var sb strings.Builder
	sb.WriteString("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n\n")
	sb.WriteString(fmt.Sprintf("üÜî ID: `%d`\n", profile.User.TelegramID))
	sb.WriteString(fmt.Sprintf("üìù Username: @%s\n", profile.User.Username))
	sb.WriteString(fmt.Sprintf("üí∞ –ë–∞–ª–∞–Ω—Å: %.2f ‚ÇΩ\n", profile.User.Balance))
	sb.WriteString(fmt.Sprintf("üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: %s\n\n", profile.User.CreatedAt.Format("02.01.2006")))

	// –ü–æ–¥–ø–∏—Å–∫–∏
	if len(profile.Subscriptions) > 0 {
		sb.WriteString("üîë –ü–æ–¥–ø–∏—Å–∫–∏:\n")
		for _, sub := range profile.Subscriptions {
			status := "‚úÖ"
			if !sub.IsActive || sub.ExpiresAt.Before(time.Now()) {
				status = "‚ùå"
			}
			sb.WriteString(fmt.Sprintf("‚Ä¢ %s %s %s –¥–æ %s\n",
				status, sub.Product.CountryFlag, sub.Product.Name,
				sub.ExpiresAt.Format("02.01.06")))
		}
	} else {
		sb.WriteString("üîë –ü–æ–¥–ø–∏—Å–æ–∫ –Ω–µ—Ç\n")
	}

	text := sb.String()

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å", "admin_user_topup"),
			menu.Data("üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", "admin_user_gift"),
		),
		menu.Row(menu.Data("‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ", "admin_user_message")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")),
	)

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º userID –≤ —Å–µ—Å—Å–∏–∏
	adminFSM.mu.Lock()
	if session, ok := adminFSM.sessions[c.Sender().ID]; ok {
		session.userID = profile.User.TelegramID
	} else {
		adminFSM.sessions[c.Sender().ID] = &adminSession{userID: profile.User.TelegramID}
	}
	adminFSM.mu.Unlock()

	if c.Message() != nil {
		// –ò—Å–ø–æ–ª—å–∑—É–µ–º Edit –µ—Å–ª–∏ —ç—Ç–æ callback, –∏–Ω–∞—á–µ Send
		if c.Message() != nil {
			msg, _ := c.Bot().Send(c.Chat(), text, menu)
			c.Bot().Delete(c.Message())
			h.saveMenuMessage(c.Sender().ID, msg.ID)
		} else {
			return editOrEditCaptionAdmin(c, text, menu)
		}
		return nil
	}
	return c.Edit(text, menu)
}

// HandleUserTopupStart –Ω–∞—á–∏–Ω–∞–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
func (h *Handler) HandleUserTopupStart(c tele.Context) error {
	respondAdmin(c)

	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 {
		// –ù—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		return h.HandleUserSearchStart(c)
	}

	h.setAdminState(c.Sender().ID, "topup_amount")

	text := fmt.Sprintf("üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `%d`\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É:", session.userID)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")),
	)

	return c.Edit(text, menu)
}

// HandleUserTopupAmount –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
func (h *Handler) HandleUserTopupAmount(c tele.Context) error {
	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 {
		h.clearAdminState(c.Sender().ID)
		text := "‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	amount, err := strconv.ParseFloat(strings.TrimSpace(c.Text()), 64)
	if err != nil || amount <= 0 {
		text := "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞\n\n–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0:"
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	if err := h.svc.AddUserBalance(context.Background(), session.userID, amount); err != nil {
		h.clearAdminState(c.Sender().ID)
		text := fmt.Sprintf("‚ùå –û—à–∏–±–∫–∞: %v", err)
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	h.clearAdminState(c.Sender().ID)

	text := fmt.Sprintf("‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `%d` –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ %.2f ‚ÇΩ", session.userID, amount)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üë• –ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º", "admin_users")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –í –º–µ–Ω—é", "admin_back")),
	)

	msg, _ := c.Bot().Send(c.Chat(), text, menu)
	c.Bot().Delete(c.Message())
	h.saveMenuMessage(c.Sender().ID, msg.ID)
	return nil
}

// HandleUserGiftStart –Ω–∞—á–∏–Ω–∞–µ—Ç –≤—ã–¥–∞—á—É –ø–æ–¥–ø–∏—Å–∫–∏
func (h *Handler) HandleUserGiftStart(c tele.Context) error {
	respondAdmin(c)

	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 {
		return h.HandleUserSearchStart(c)
	}

	products, err := h.svc.GetAllProducts(context.Background())
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤"})
	}

	text := fmt.Sprintf("üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `%d`\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é:", session.userID)

	menu := &tele.ReplyMarkup{}
	var rows []tele.Row

	for _, p := range products {
		btnText := fmt.Sprintf("%s %s", p.CountryFlag, p.Name)
		btn := menu.Data(btnText, "gift_product", strconv.FormatInt(p.ID, 10))
		rows = append(rows, menu.Row(btn))
	}

	rows = append(rows, menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")))
	menu.Inline(rows...)

	return c.Edit(text, menu)
}

// HandleUserGiftProduct –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞
func (h *Handler) HandleUserGiftProduct(c tele.Context) error {
	respondAdmin(c)

	productID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	adminFSM.mu.Lock()
	if session, ok := adminFSM.sessions[c.Sender().ID]; ok {
		session.productID = productID
		session.state = "gift_days"
	} else {
		adminFSM.sessions[c.Sender().ID] = &adminSession{productID: productID, state: "gift_days"}
	}
	adminFSM.mu.Unlock()

	text := "üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("30 –¥–Ω–µ–π", "gift_days_btn", "30"),
			menu.Data("90 –¥–Ω–µ–π", "gift_days_btn", "90"),
		),
		menu.Row(
			menu.Data("180 –¥–Ω–µ–π", "gift_days_btn", "180"),
			menu.Data("365 –¥–Ω–µ–π", "gift_days_btn", "365"),
		),
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")),
	)

	return c.Edit(text, menu)
}

// HandleUserGiftDaysBtn –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –¥–Ω–µ–π —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
func (h *Handler) HandleUserGiftDaysBtn(c tele.Context) error {
	respondAdmin(c)

	days, _ := strconv.Atoi(c.Callback().Data)

	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 || session.productID == 0 {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞"})
	}

	sub, err := h.svc.GiftSubscription(context.Background(), session.userID, session.productID, days)
	if err != nil {
		h.clearAdminState(c.Sender().ID)
		return c.Respond(&tele.CallbackResponse{Text: fmt.Sprintf("–û—à–∏–±–∫–∞: %v", err)})
	}

	h.clearAdminState(c.Sender().ID)

	text := fmt.Sprintf("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\n%s %s\nüìÖ –î–æ: %s\n\nüîë –ö–ª—é—á:\n`%s`",
		sub.Product.CountryFlag, sub.Product.Name,
		sub.ExpiresAt.Format("02.01.2006"),
		sub.KeyString)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üë• –ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º", "admin_users")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –í –º–µ–Ω—é", "admin_back")),
	)

	// –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	userMsg := fmt.Sprintf("üéÅ –í–∞–º –ø–æ–¥–∞—Ä–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞!\n\n%s %s\nüìÖ –î–æ: %s\n\nüîë –ö–ª—é—á:\n`%s`",
		sub.Product.CountryFlag, sub.Product.Name,
		sub.ExpiresAt.Format("02.01.2006"),
		sub.KeyString)

	_, err = c.Bot().Send(&tele.User{ID: session.userID}, userMsg)
	if err != nil {
		log.Printf("Failed to notify user %d: %v", session.userID, err)
	}

	return c.Edit(text, menu)
}

// HandleUserGiftDays –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –¥–Ω–µ–π
func (h *Handler) HandleUserGiftDays(c tele.Context) error {
	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 || session.productID == 0 {
		h.clearAdminState(c.Sender().ID)
		text := "‚ùå –û—à–∏–±–∫–∞"
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	days, err := strconv.Atoi(strings.TrimSpace(c.Text()))
	if err != nil || days <= 0 {
		text := "‚ùå –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π\n\n–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0:"
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	sub, err := h.svc.GiftSubscription(context.Background(), session.userID, session.productID, days)
	if err != nil {
		h.clearAdminState(c.Sender().ID)
		text := fmt.Sprintf("‚ùå –û—à–∏–±–∫–∞: %v", err)
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	h.clearAdminState(c.Sender().ID)

	// –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞
	text := fmt.Sprintf("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!\n\n%s %s\nüìÖ –î–æ: %s\n\nüîë –ö–ª—é—á:\n`%s`",
		sub.Product.CountryFlag, sub.Product.Name,
		sub.ExpiresAt.Format("02.01.2006"),
		sub.KeyString)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üë• –ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º", "admin_users")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –í –º–µ–Ω—é", "admin_back")),
	)

	// –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	userMsg := fmt.Sprintf("üéÅ –í–∞–º –ø–æ–¥–∞—Ä–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞!\n\n%s %s\nüìÖ –î–æ: %s\n\nüîë –ö–ª—é—á:\n`%s`",
		sub.Product.CountryFlag, sub.Product.Name,
		sub.ExpiresAt.Format("02.01.2006"),
		sub.KeyString)

	_, err = c.Bot().Send(&tele.User{ID: session.userID}, userMsg)
	if err != nil {
		log.Printf("Failed to notify user %d: %v", session.userID, err)
	}

	msg, _ := c.Bot().Send(c.Chat(), text, menu)
	c.Bot().Delete(c.Message())
	h.saveMenuMessage(c.Sender().ID, msg.ID)
	return nil
}

// HandleUserMessageStart –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è
func (h *Handler) HandleUserMessageStart(c tele.Context) error {
	respondAdmin(c)

	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 {
		return h.HandleUserSearchStart(c)
	}

	h.setAdminState(c.Sender().ID, "message_text")

	text := fmt.Sprintf("‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `%d`\n\n–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:", session.userID)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_user_back")),
	)

	return c.Edit(text, menu)
}

// HandleUserMessageText –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
func (h *Handler) HandleUserMessageText(c tele.Context) error {
	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.userID == 0 {
		h.clearAdminState(c.Sender().ID)
		text := "‚ùå –û—à–∏–±–∫–∞"
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	msgText := c.Text()
	_, err := c.Bot().Send(&tele.User{ID: session.userID}, msgText)
	if err != nil {
		h.clearAdminState(c.Sender().ID)
		text := fmt.Sprintf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: %v", err)
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_user_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	h.clearAdminState(c.Sender().ID)

	confirmText := fmt.Sprintf("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é `%d`", session.userID)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üë• –ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º", "admin_users")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –í –º–µ–Ω—é", "admin_back")),
	)

	msg, _ := c.Bot().Send(c.Chat(), confirmText, menu)
	c.Bot().Delete(c.Message())
	h.saveMenuMessage(c.Sender().ID, msg.ID)
	return nil
}

// ================= BROADCAST =================

// HandleAdminBroadcast –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É
func (h *Handler) HandleAdminBroadcast(c tele.Context) error {
	respondAdmin(c)

	broadcast.mu.Lock()
	if broadcast.isActive {
		broadcast.mu.Unlock()
		return c.Respond(&tele.CallbackResponse{Text: "–†–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"})
	}
	broadcast.waitingMsg = true
	broadcast.waitingConfirm = false
	broadcast.adminID = c.Sender().ID
	broadcast.message = nil
	broadcast.mu.Unlock()

	text := "üì¢ –†–∞—Å—Å—ã–ª–∫–∞\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ), –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —Ä–∞–∑–æ—Å–ª–∞–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º."

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_cancel_broadcast")),
	)

	return c.Edit(text, menu)
}

// HandleCancelBroadcast –æ—Ç–º–µ–Ω—è–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É
func (h *Handler) HandleCancelBroadcast(c tele.Context) error {
	respondAdmin(c)

	broadcast.mu.Lock()
	broadcast.waitingMsg = false
	broadcast.waitingConfirm = false
	broadcast.adminID = 0
	broadcast.message = nil
	broadcast.mu.Unlock()

	return h.HandleAdmin(c)
}

// HandleBroadcastMessage –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
func (h *Handler) HandleBroadcastMessage(c tele.Context) error {
	broadcast.mu.Lock()
	if !broadcast.waitingMsg || broadcast.adminID != c.Sender().ID {
		broadcast.mu.Unlock()
		return nil
	}
	broadcast.waitingMsg = false
	broadcast.waitingConfirm = true
	broadcast.message = c.Message()
	broadcast.mu.Unlock()

	userIDs, err := h.svc.GetAllUserTelegramIDs(context.Background())
	if err != nil {
		broadcast.mu.Lock()
		broadcast.waitingConfirm = false
		broadcast.mu.Unlock()
		text := fmt.Sprintf("‚ùå –û—à–∏–±–∫–∞: %v", err)
		menu := &tele.ReplyMarkup{}
		menu.Inline(menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "admin_back")))
		return editOrEditCaptionAdmin(c, text, menu)
	}

	totalUsers := len(userIDs)

	text := fmt.Sprintf("üì¢ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏\n\n–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ %d –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.\n\n–û—Ç–ø—Ä–∞–≤–∏—Ç—å?", totalUsers)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("‚úÖ –î–∞", "admin_confirm_broadcast"),
			menu.Data("‚ùå –ù–µ—Ç", "admin_cancel_broadcast"),
		),
	)

	msg, _ := c.Bot().Send(c.Chat(), text, menu)
	c.Bot().Delete(c.Message())
	h.saveMenuMessage(c.Sender().ID, msg.ID)
	return nil
}

// HandleConfirmBroadcast –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É
func (h *Handler) HandleConfirmBroadcast(c tele.Context) error {
	respondAdmin(c)

	broadcast.mu.Lock()
	if !broadcast.waitingConfirm || broadcast.adminID != c.Sender().ID || broadcast.message == nil {
		broadcast.mu.Unlock()
		return c.Respond(&tele.CallbackResponse{Text: "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏"})
	}
	broadcast.waitingConfirm = false
	broadcast.isActive = true
	msg := broadcast.message
	broadcast.mu.Unlock()

	userIDs, err := h.svc.GetAllUserTelegramIDs(context.Background())
	if err != nil {
		broadcast.mu.Lock()
		broadcast.isActive = false
		broadcast.mu.Unlock()
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞"})
	}

	totalUsers := len(userIDs)
	log.Printf("[BROADCAST] Started to %d users", totalUsers)

	c.Edit(fmt.Sprintf("üì§ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!\n\n–û—Ç–ø—Ä–∞–≤–ª—è—é %d –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º...", totalUsers))

	// –ó–∞–ø—É—Å–∫–∞–µ–º –≤ goroutine
	go func() {
		bot := c.Bot()
		adminID := c.Sender().ID

		var sent, failed int
		ticker := time.NewTicker(50 * time.Millisecond)
		defer ticker.Stop()

		for _, userID := range userIDs {
			<-ticker.C

			var err error
			if msg.Photo != nil {
				photo := &tele.Photo{
					File:    msg.Photo.File,
					Caption: msg.Caption,
				}
				_, err = bot.Send(&tele.User{ID: userID}, photo)
			} else if msg.Video != nil {
				video := &tele.Video{
					File:    msg.Video.File,
					Caption: msg.Caption,
				}
				_, err = bot.Send(&tele.User{ID: userID}, video)
			} else if msg.Document != nil {
				doc := &tele.Document{
					File:    msg.Document.File,
					Caption: msg.Caption,
				}
				_, err = bot.Send(&tele.User{ID: userID}, doc)
			} else {
				_, err = bot.Send(&tele.User{ID: userID}, msg.Text)
			}

			if err != nil {
				failed++
			} else {
				sent++
			}

			// –ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 100
			if (sent+failed)%100 == 0 && totalUsers > 100 {
				bot.Send(&tele.User{ID: adminID}, fmt.Sprintf("üì§ –ü—Ä–æ–≥—Ä–µ—Å—Å: %d/%d", sent+failed, totalUsers))
			}
		}

		broadcast.mu.Lock()
		broadcast.isActive = false
		broadcast.message = nil
		broadcast.mu.Unlock()

		log.Printf("[BROADCAST] Finished. Sent: %d, Failed: %d", sent, failed)

		bot.Send(&tele.User{ID: adminID}, fmt.Sprintf("‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\nüì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: %d\n‚ùå –û—à–∏–±–æ–∫: %d", sent, failed))
	}()

	return nil
}

// ================= ISSUE KEY =================

// HandleAdminIssue –Ω–∞—á–∏–Ω–∞–µ—Ç –≤—ã–¥–∞—á—É –∫–ª—é—á–∞
func (h *Handler) HandleAdminIssue(c tele.Context) error {
	respondAdmin(c)

	products, err := h.svc.GetAllProducts(context.Background())
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"})
	}

	text := "üîë –í—ã–¥–∞—á–∞ –∫–ª—é—á–∞\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é:"

	menu := &tele.ReplyMarkup{}
	var rows []tele.Row

	for _, p := range products {
		btnText := fmt.Sprintf("%s %s", p.CountryFlag, p.Name)
		btn := menu.Data(btnText, "issue_product", strconv.FormatInt(p.ID, 10))
		rows = append(rows, menu.Row(btn))
	}

	rows = append(rows, menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_back")))
	menu.Inline(rows...)

	return c.Edit(text, menu)
}

// HandleIssueProduct –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞
func (h *Handler) HandleIssueProduct(c tele.Context) error {
	respondAdmin(c)

	productID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	text := "üîë –í—ã–¥–∞—á–∞ –∫–ª—é—á–∞\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("30 –¥–Ω–µ–π", "issue_days", "30"),
			menu.Data("90 –¥–Ω–µ–π", "issue_days", "90"),
		),
		menu.Row(
			menu.Data("180 –¥–Ω–µ–π", "issue_days", "180"),
			menu.Data("365 –¥–Ω–µ–π", "issue_days", "365"),
		),
		menu.Row(menu.Data("üîì –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏", "issue_no_user", strconv.FormatInt(productID, 10))),
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_back")),
	)

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º productID
	adminFSM.mu.Lock()
	if session, ok := adminFSM.sessions[c.Sender().ID]; ok {
		session.productID = productID
	} else {
		adminFSM.sessions[c.Sender().ID] = &adminSession{productID: productID}
	}
	adminFSM.mu.Unlock()

	return c.Edit(text, menu)
}

// HandleIssueDays –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞
func (h *Handler) HandleIssueDays(c tele.Context) error {
	respondAdmin(c)

	days, _ := strconv.Atoi(c.Callback().Data)

	session, ok := h.getAdminSession(c.Sender().ID)
	if !ok || session.productID == 0 {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞"})
	}

	// –°–æ–∑–¥–∞—ë–º –∫–ª—é—á –¥–ª—è –∞–¥–º–∏–Ω–∞ (–±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏)
	sub, err := h.svc.GiftSubscription(context.Background(), c.Sender().ID, session.productID, days)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: fmt.Sprintf("–û—à–∏–±–∫–∞: %v", err)})
	}

	h.clearAdminState(c.Sender().ID)

	text := fmt.Sprintf("‚úÖ –ö–ª—é—á —Å–æ–∑–¥–∞–Ω!\n\nüìÖ –°—Ä–æ–∫: %d –¥–Ω–µ–π\nüìÖ –î–æ: %s\n\nüîë –ö–ª—é—á:\n`%s`",
		days, sub.ExpiresAt.Format("02.01.2006"), sub.KeyString)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üîë –í—ã–¥–∞—Ç—å –µ—â—ë", "admin_issue")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –í –º–µ–Ω—é", "admin_back")),
	)

	return c.Edit(text, menu)
}

// HandleIssueNoUser —Å–æ–∑–¥–∞—ë—Ç –∫–ª—é—á –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏
func (h *Handler) HandleIssueNoUser(c tele.Context) error {
	respondAdmin(c)

	productID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	text := "üîë –í—ã–¥–∞—á–∞ –∫–ª—é—á–∞\n\n–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("‚ùå –û—Ç–º–µ–Ω–∞", "admin_back")),
	)

	adminFSM.mu.Lock()
	if session, ok := adminFSM.sessions[c.Sender().ID]; ok {
		session.productID = productID
		session.state = "issue_days"
	} else {
		adminFSM.sessions[c.Sender().ID] = &adminSession{productID: productID, state: "issue_days"}
	}
	adminFSM.mu.Unlock()

	return c.Edit(text, menu)
}

// HandleIssueCancel –æ—Ç–º–µ–Ω—è–µ—Ç –≤—ã–¥–∞—á—É
func (h *Handler) HandleIssueCancel(c tele.Context) error {
	respondAdmin(c)
	h.clearAdminState(c.Sender().ID)
	return h.HandleAdmin(c)
}
