package handlers

import (
	"context"
	"fmt"
	"log"
	"strconv"
	"strings"
	"sync"
	"time"

	"vpn-telegram-bot/internal/service"

	tele "gopkg.in/telebot.v3"
)

// Handler –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞
type Handler struct {
	svc      *service.Service
	adminIDs []int64
	// userMenus —Ö—Ä–∞–Ω–∏—Ç ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–Ω—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	userMenus sync.Map // map[int64]int (userID -> messageID)
}

// New —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π handler
func New(svc *service.Service, adminIDs []int64) *Handler {
	return &Handler{
		svc:      svc,
		adminIDs: adminIDs,
	}
}

// saveMenuMessage —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ID —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (h *Handler) saveMenuMessage(userID int64, msgID int) {
	h.userMenus.Store(userID, msgID)
}

// getMenuMessage –ø–æ–ª—É—á–∞–µ—Ç ID —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (h *Handler) getMenuMessage(userID int64) (int, bool) {
	if val, ok := h.userMenus.Load(userID); ok {
		return val.(int), true
	}
	return 0, false
}

// deleteOldMenu —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (h *Handler) deleteOldMenu(c tele.Context) {
	if msgID, ok := h.getMenuMessage(c.Sender().ID); ok {
		c.Bot().Delete(&tele.Message{
			ID:   msgID,
			Chat: c.Chat(),
		})
	}
}

// respond –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ callback –∏ —É–±–∏—Ä–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
func respond(c tele.Context) {
	if c.Callback() != nil {
		c.Respond()
	}
}

// editOrEditCaption –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç EditCaption (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ) –∏–ª–∏ Edit
func editOrEditCaption(c tele.Context, text string, menu *tele.ReplyMarkup) error {
	if c.Message() != nil && c.Message().Photo != nil {
		return c.EditCaption(text, menu)
	}
	return c.Edit(text, menu)
}

// editOrSend —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —ç—Ç–æ callback, –∏–Ω–∞—á–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç EditCaption –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–æ—Ç–æ, –∏–Ω–∞—á–µ Edit
func (h *Handler) editOrSend(c tele.Context, text string, menu *tele.ReplyMarkup) error {
	respond(c)

	if c.Callback() != nil {
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
		if c.Message() != nil && c.Message().Photo != nil {
			// –ò—Å–ø–æ–ª—å–∑—É–µ–º EditCaption —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
			return c.EditCaption(text, menu)
		}
		// –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π Edit
		return c.Edit(text, menu)
	}

	// –î–ª—è –∫–æ–º–∞–Ω–¥ ‚Äî —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
	h.deleteOldMenu(c)
	msg, err := c.Bot().Send(c.Chat(), text, menu)
	if err != nil {
		return err
	}
	h.saveMenuMessage(c.Sender().ID, msg.ID)
	return nil
}

// Register —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
func (h *Handler) Register(b *tele.Bot) {
	// Commands
	b.Handle("/start", h.HandleStart)
	b.Handle("/help", h.HandleHelp)
	b.Handle("/guide", h.HandleGuide)
	b.Handle("/tariffs", h.HandleTariffs)
	b.Handle("/mysubs", h.HandleMySubs)
	b.Handle("/privacy", h.HandlePrivacy)

	// Callbacks
	b.Handle(&tele.Btn{Unique: "tariffs"}, h.HandleTariffs)
	b.Handle(&tele.Btn{Unique: "mysubs"}, h.HandleMySubs)
	b.Handle(&tele.Btn{Unique: "instruction"}, h.HandleInstruction)
	b.Handle(&tele.Btn{Unique: "help"}, h.HandleHelp)
	b.Handle(&tele.Btn{Unique: "back_main"}, h.HandleBackMain)
	b.Handle(&tele.Btn{Unique: "privacy"}, h.HandlePrivacy)

	// Product selection
	b.Handle(&tele.Btn{Unique: "product"}, h.HandleProductSelect)

	// Plan selection (months)
	b.Handle(&tele.Btn{Unique: "plan"}, h.HandlePlanSelect)

	// Subscription details
	b.Handle(&tele.Btn{Unique: "sub"}, h.HandleSubDetail)
	b.Handle(&tele.Btn{Unique: "copy_key"}, h.HandleCopyKey)
	b.Handle(&tele.Btn{Unique: "extend"}, h.HandleExtend)

	// Instructions
	b.Handle(&tele.Btn{Unique: "instr_android"}, h.HandleInstrAndroid)
	b.Handle(&tele.Btn{Unique: "instr_windows"}, h.HandleInstrWindows)
	b.Handle(&tele.Btn{Unique: "instr_iphone"}, h.HandleInstrIphone)
	b.Handle(&tele.Btn{Unique: "instr_mac"}, h.HandleInstrMac)

	// Help section
	b.Handle(&tele.Btn{Unique: "faq"}, h.HandleFAQ)
	b.Handle(&tele.Btn{Unique: "reviews"}, h.HandleReviews)
	b.Handle(&tele.Btn{Unique: "leave_review"}, h.HandleLeaveReview)
	b.Handle(&tele.Btn{Unique: "support"}, h.HandleSupport)
}

// ================= MAIN MENU =================

// HandleStart –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç /start
func (h *Handler) HandleStart(c tele.Context) error {
	log.Printf("üë§ User: @%s | ID: %d", c.Sender().Username, c.Sender().ID)

	// –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	_, err := h.svc.GetOrCreateUser(context.Background(), c.Sender().ID, c.Sender().Username)
	if err != nil {
		log.Printf("Error getting user: %v", err)
	}

	// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é
	h.deleteOldMenu(c)

	text := `üê∏ –ô–æ—É! –≠—Ç–æ PEPE VPN

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π VPN –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:`

	menu := h.mainMenuKeyboard()

	msg, err := c.Bot().Send(c.Chat(), text, menu)
	if err != nil {
		return err
	}
	h.saveMenuMessage(c.Sender().ID, msg.ID)
	return nil
}

// HandleBackMain –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (—á–µ—Ä–µ–∑ EditCaption)
func (h *Handler) HandleBackMain(c tele.Context) error {
	respond(c)

	text := `üê∏ –ô–æ—É! –≠—Ç–æ PEPE VPN

–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π VPN –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:`

	menu := h.mainMenuKeyboard()
	return editOrEditCaption(c, text, menu)
}

// mainMenuKeyboard –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
func (h *Handler) mainMenuKeyboard() *tele.ReplyMarkup {
	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("üíé –¢–∞—Ä–∏—Ñ—ã", "tariffs"),
			menu.Data("üîë –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏", "mysubs"),
		),
		menu.Row(
			menu.Data("üìö –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "instruction"),
			menu.Data("üõü –ü–æ–º–æ—â—å", "help"),
		),
	)
	return menu
}

// ================= TARIFFS =================

// HandleTariffs –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∞—Ä–∏—Ñ—ã
func (h *Handler) HandleTariffs(c tele.Context) error {
	respond(c)

	products, err := h.svc.GetAllProducts(context.Background())
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"})
	}

	text := "üåç –í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–∫–∞—Ü–∏—é —Å–µ—Ä–≤–µ—Ä–∞:"

	menu := &tele.ReplyMarkup{}
	var rows []tele.Row

	for _, p := range products {
		btnText := fmt.Sprintf("%s %s ‚Äî %d ‚ÇΩ/–º–µ—Å", p.CountryFlag, p.Name, int(p.BasePrice))
		btn := menu.Data(btnText, "product", strconv.FormatInt(p.ID, 10))
		rows = append(rows, menu.Row(btn))
	}

	rows = append(rows, menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")))
	menu.Inline(rows...)

	if c.Callback() != nil {
		return editOrEditCaption(c, text, menu)
	}
	return h.editOrSend(c, text, menu)
}

// HandleProductSelect –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞
func (h *Handler) HandleProductSelect(c tele.Context) error {
	respond(c)

	productID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	product, err := h.svc.GetProductByID(context.Background(), productID)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"})
	}

	plans := h.svc.GetPricingPlans(product.BasePrice)

	desc := product.Description
	if desc == "" {
		desc = "–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ"
	}

	text := fmt.Sprintf(`%s %s

üí∞ –¶–µ–Ω–∞: %d ‚ÇΩ/–º–µ—Å
üìù %s

–°–∫–∏–¥–∫–∏: 6 –º–µ—Å -10%%, 12 –º–µ—Å -20%%

–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫:`, product.CountryFlag, product.Name, int(product.BasePrice), desc)

	menu := &tele.ReplyMarkup{}
	var rows []tele.Row

	for _, plan := range plans {
		var btnText string
		if plan.Discount > 0 {
			btnText = fmt.Sprintf("%d –º–µ—Å (-%d%%) ‚Äî %d ‚ÇΩ", plan.Months, plan.Discount, int(plan.Price))
		} else if plan.Months == 1 {
			btnText = fmt.Sprintf("1 –º–µ—Å ‚Äî %d ‚ÇΩ", int(plan.Price))
		} else {
			btnText = fmt.Sprintf("%d –º–µ—Å ‚Äî %d ‚ÇΩ", plan.Months, int(plan.Price))
		}
		btn := menu.Data(btnText, "plan", fmt.Sprintf("%d:%d", productID, plan.Months))
		rows = append(rows, menu.Row(btn))
	}

	rows = append(rows, menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "tariffs")))
	menu.Inline(rows...)

	return editOrEditCaption(c, text, menu)
}

// HandlePlanSelect –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–ª–∞–Ω–∞
func (h *Handler) HandlePlanSelect(c tele.Context) error {
	respond(c)

	parts := strings.Split(c.Callback().Data, ":")
	if len(parts) != 2 {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞"})
	}

	productID, _ := strconv.ParseInt(parts[0], 10, 64)
	months, _ := strconv.Atoi(parts[1])

	product, err := h.svc.GetProductByID(context.Background(), productID)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"})
	}

	price, discount := h.svc.CalculatePrice(product.BasePrice, months)

	var discountText string
	if discount > 0 {
		discountText = fmt.Sprintf(" (-%d%%)", discount)
	}

	text := fmt.Sprintf(`üí≥ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

%s %s
üìÖ –°—Ä–æ–∫: %d –º–µ—Å.
üí∞ –ò—Ç–æ–≥–æ: %d ‚ÇΩ%s

–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:`, product.CountryFlag, product.Name, months, int(price), discountText)

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üí≥ –ö–∞—Ä—Ç–æ–π –†–§", "pay_card", c.Callback().Data)),
		menu.Row(menu.Data("ü™ô –ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞", "pay_crypto", c.Callback().Data)),
		menu.Row(menu.Data("üí∞ –° –±–∞–ª–∞–Ω—Å–∞", "pay_balance", c.Callback().Data)),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "product", strconv.FormatInt(productID, 10))),
	)

	return editOrEditCaption(c, text, menu)
}

// ================= MY SUBSCRIPTIONS =================

// HandleMySubs –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (h *Handler) HandleMySubs(c tele.Context) error {
	respond(c)

	user, err := h.svc.GetOrCreateUser(context.Background(), c.Sender().ID, c.Sender().Username)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞"})
	}

	subs, err := h.svc.GetUserSubscriptions(context.Background(), user.ID)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"})
	}

	menu := &tele.ReplyMarkup{}

	if len(subs) == 0 {
		text := `üîë –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏

–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫.
–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ –ø–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å!`

		menu.Inline(
			menu.Row(menu.Data("üíé –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ", "tariffs")),
			menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")),
		)

		if c.Callback() != nil {
			return editOrEditCaption(c, text, menu)
		}
		return h.editOrSend(c, text, menu)
	}

	text := "üîë –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏:\n"

	var rows []tele.Row

	for _, sub := range subs {
		status := "‚úÖ"
		if sub.ExpiresAt.Before(time.Now()) || !sub.IsActive {
			status = "‚ùå"
		}

		btnText := fmt.Sprintf("%s %s %s ‚Ññ%d", status, sub.Product.CountryFlag, sub.Product.Name, sub.ID)
		btn := menu.Data(btnText, "sub", strconv.FormatInt(sub.ID, 10))
		rows = append(rows, menu.Row(btn))
	}

	rows = append(rows, menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")))
	menu.Inline(rows...)

	if c.Callback() != nil {
		return editOrEditCaption(c, text, menu)
	}
	return h.editOrSend(c, text, menu)
}

// HandleSubDetail –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏
func (h *Handler) HandleSubDetail(c tele.Context) error {
	respond(c)

	subID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	sub, err := h.svc.GetSubscriptionByID(context.Background(), subID)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"})
	}

	status := "‚úÖ –ê–∫—Ç–∏–≤–Ω–∞"
	if sub.ExpiresAt.Before(time.Now()) || !sub.IsActive {
		status = "‚ùå –ò—Å—Ç–µ–∫–ª–∞"
	}

	text := fmt.Sprintf(`üì¶ –ü–æ–¥–ø–∏—Å–∫–∞ ‚Ññ%d

%s %s
%s
üìÖ –î–æ: %s

üîë –ö–ª—é—á (–Ω–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å):`,
		sub.ID, sub.Product.CountryFlag, sub.Product.Name, status, sub.ExpiresAt.Format("02.01.2006 15:04"))

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üìã –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á", "copy_key", strconv.FormatInt(subID, 10))),
		menu.Row(menu.Data("üîÑ –ü—Ä–æ–¥–ª–∏—Ç—å", "extend", strconv.FormatInt(subID, 10))),
		menu.Row(menu.Data("üìö –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "instruction")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "mysubs")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleCopyKey –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª—é—á –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
func (h *Handler) HandleCopyKey(c tele.Context) error {
	subID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	sub, err := h.svc.GetSubscriptionByID(context.Background(), subID)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–û—à–∏–±–∫–∞"})
	}

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª—é—á –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
	c.Bot().Send(c.Chat(), sub.KeyString)

	return c.Respond(&tele.CallbackResponse{Text: "‚úÖ –ö–ª—é—á –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∏–∂–µ"})
}

// HandleExtend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–¥–ª–µ–Ω–∏—è
func (h *Handler) HandleExtend(c tele.Context) error {
	respond(c)

	subID, _ := strconv.ParseInt(c.Callback().Data, 10, 64)

	sub, err := h.svc.GetSubscriptionByID(context.Background(), subID)
	if err != nil {
		return c.Respond(&tele.CallbackResponse{Text: "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"})
	}

	plans := h.svc.GetPricingPlans(sub.Product.BasePrice)

	text := fmt.Sprintf(`üîÑ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Ññ%d

%s %s
–¢–µ–∫—É—â–∏–π —Å—Ä–æ–∫: –¥–æ %s

–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:`, sub.ID, sub.Product.CountryFlag, sub.Product.Name, sub.ExpiresAt.Format("02.01.2006"))

	menu := &tele.ReplyMarkup{}
	var rows []tele.Row

	for _, plan := range plans {
		var btnText string
		if plan.Discount > 0 {
			btnText = fmt.Sprintf("%d –º–µ—Å (-%d%%) ‚Äî %d ‚ÇΩ", plan.Months, plan.Discount, int(plan.Price))
		} else {
			btnText = fmt.Sprintf("%d –º–µ—Å ‚Äî %d ‚ÇΩ", plan.Months, int(plan.Price))
		}
		btn := menu.Data(btnText, "extend_pay", fmt.Sprintf("%d:%d", subID, plan.Months))
		rows = append(rows, menu.Row(btn))
	}

	rows = append(rows, menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "sub", strconv.FormatInt(subID, 10))))
	menu.Inline(rows...)

	return editOrEditCaption(c, text, menu)
}

// ================= INSTRUCTIONS =================

// HandleGuide –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç /guide (—Ç–æ –∂–µ —á—Ç–æ HandleInstruction)
func (h *Handler) HandleGuide(c tele.Context) error {
	return h.HandleInstruction(c)
}

// HandleInstruction –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
func (h *Handler) HandleInstruction(c tele.Context) error {
	respond(c)

	text := "üìö –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(
			menu.Data("üì± Android", "instr_android"),
			menu.Data("üíª Windows", "instr_windows"),
		),
		menu.Row(
			menu.Data("üçé iPhone", "instr_iphone"),
			menu.Data("üçè Mac", "instr_mac"),
		),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")),
	)

	if c.Callback() != nil {
		return editOrEditCaption(c, text, menu)
	}
	return h.editOrSend(c, text, menu)
}

// HandleInstrAndroid –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Android
func (h *Handler) HandleInstrAndroid(c tele.Context) error {
	respond(c)

	text := `üì± Android

1. –°–∫–∞—á–∞–π—Ç–µ V2RayTun –∏–∑ Google Play
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
3. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞–∂–º–∏—Ç–µ + ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞"
4. –ù–∞–∂–º–∏—Ç–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üì• –°–∫–∞—á–∞—Ç—å V2RayTun", "https://play.google.com/store/apps/details?id=com.v2raytun.android")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "instruction")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleInstrWindows –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Windows
func (h *Handler) HandleInstrWindows(c tele.Context) error {
	respond(c)

	text := `üíª Windows

1. –°–∫–∞—á–∞–π—Ç–µ V2RayTun —Å GitHub
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
3. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞–∂–º–∏—Ç–µ + ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞"
4. –ù–∞–∂–º–∏—Ç–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üì• –°–∫–∞—á–∞—Ç—å V2RayTun", "https://github.com/nicetry/v2raytun/releases")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "instruction")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleInstrIphone –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è iPhone
func (h *Handler) HandleInstrIphone(c tele.Context) error {
	respond(c)

	text := `üçé iPhone

1. –°–∫–∞—á–∞–π—Ç–µ V2RayTun –∏–ª–∏ Streisand –∏–∑ App Store
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
3. –ù–∞–∂–º–∏—Ç–µ + ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞"
4. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å—Ç–∞–≤–∫—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å`

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üì• V2RayTun", "https://apps.apple.com/app/v2raytun/id6476628951")),
		menu.Row(menu.URL("üì• Streisand", "https://apps.apple.com/app/streisand/id6450534064")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "instruction")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleInstrMac –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Mac
func (h *Handler) HandleInstrMac(c tele.Context) error {
	respond(c)

	text := `üçè Mac

1. –°–∫–∞—á–∞–π—Ç–µ V2RayTun –∏–∑ App Store
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏"
3. –ù–∞–∂–º–∏—Ç–µ + ‚Üí "–î–æ–±–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞"
4. –ù–∞–∂–º–∏—Ç–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üì• –°–∫–∞—á–∞—Ç—å V2RayTun", "https://apps.apple.com/app/v2raytun/id6476628951")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "instruction")),
	)

	return editOrEditCaption(c, text, menu)
}

// ================= HELP =================

// HandleHelp –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–¥–µ–ª –ø–æ–º–æ—â–∏
func (h *Handler) HandleHelp(c tele.Context) error {
	respond(c)

	text := "üõü –ü–æ–º–æ—â—å\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("‚ùì FAQ", "faq")),
		menu.Row(menu.Data("‚≠êÔ∏è –û—Ç–∑—ã–≤—ã", "reviews")),
		menu.Row(menu.Data("üíå –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", "leave_review")),
		menu.Row(menu.Data("üì• –ü–æ–¥–¥–µ—Ä–∂–∫–∞", "support")),
		menu.Row(menu.Data("üìÑ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ", "privacy")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_main")),
	)

	if c.Callback() != nil {
		return editOrEditCaption(c, text, menu)
	}
	return h.editOrSend(c, text, menu)
}

// HandleFAQ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç FAQ
func (h *Handler) HandleFAQ(c tele.Context) error {
	respond(c)

	text := `‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

Q: VPN –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?
A: –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å. –ù–µ –ø–æ–º–æ–≥–ª–æ ‚Äî –ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.

Q: –°–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤?
A: –î–æ 3-—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –æ–¥–Ω–æ–º –∫–ª—é—á–µ.

Q: –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã?
A: –ö–∞—Ä—Ç—ã –†–§ –∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞.

Q: –°–∫–æ—Ä–æ—Å—Ç—å?
A: 50-200 –ú–±–∏—Ç/—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª–æ–∫–∞—Ü–∏–∏.`

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.Data("üì• –ü–æ–¥–¥–µ—Ä–∂–∫–∞", "support")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "help")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleReviews –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç–∑—ã–≤—ã
func (h *Handler) HandleReviews(c tele.Context) error {
	respond(c)

	text := "‚≠êÔ∏è –û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n–ß–∏—Ç–∞–π—Ç–µ –≤ –Ω–∞—à–µ–º –∫–∞–Ω–∞–ª–µ:"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üì¢ –ö–∞–Ω–∞–ª –æ—Ç–∑—ã–≤–æ–≤", "https://t.me/your_reviews_channel")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "help")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleLeaveReview –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
func (h *Handler) HandleLeaveReview(c tele.Context) error {
	respond(c)

	text := "üíå –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤\n\n–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º ‚Äî –æ–ø—É–±–ª–∏–∫—É–µ–º –≤ –∫–∞–Ω–∞–ª–µ!"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å", "https://t.me/your_support_bot")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "help")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandleSupport –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
func (h *Handler) HandleSupport(c tele.Context) error {
	respond(c)

	text := "üì• –ü–æ–¥–¥–µ—Ä–∂–∫–∞\n\n–û—Ç–≤–µ—Ç–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤!"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üí¨ –ù–∞–ø–∏—Å–∞—Ç—å", "https://t.me/your_support_bot")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "help")),
	)

	return editOrEditCaption(c, text, menu)
}

// HandlePrivacy –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
func (h *Handler) HandlePrivacy(c tele.Context) error {
	respond(c)

	text := "üìÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ"

	menu := &tele.ReplyMarkup{}
	menu.Inline(
		menu.Row(menu.URL("üìñ –ß–∏—Ç–∞—Ç—å", "https://telegra.ph/Publichnaya-oferta-01-01")),
		menu.Row(menu.Data("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "help")),
	)

	if c.Callback() != nil {
		return editOrEditCaption(c, text, menu)
	}
	return h.editOrSend(c, text, menu)
}
